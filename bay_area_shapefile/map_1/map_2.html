<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style>
  body {
        margin: 0;
        padding: 0;
    }
    #vis {
 //   width: 100%;
   // max-width: 2000px;
//    max-height: 2000px;
 //   margin: 0 auto;
    }
    #vis div {
        float: left;
        position: relative;
    }
    #vis path {
       /* //fill: #2ca25f;
        //stroke: #FFF;*/
        stroke-width: 1px;
    }
    #vis p.legend {
        width: 100%;
        text-align: center;
        position: absolute;
        bottom: 0;
        left: 0;
        font-weight: bold;
        font-size: 11px;
    }
    .container {
         width:1300px;
         padding-right:5px;
         padding-left:5px;
         margin-right:auto;
         margin-left:auto;
    }

    #options_container, #description_container, #srcs_container {
        padding: 15px;
        width:100%;
    }
    
    /* Tooltip CSS */
    .d3-tip {
    line-height: 1.5;
    font-weight: 400;
    font-family:"avenir next", Arial, sans-serif;
    padding: 6px;
    background: rgba(0, 0, 0, 0.6);
    color: #FFA500;
    border-radius: 1px;
    pointer-events: none;
    }

    //Source http://bl.ocks.org/micahstubbs/8e15870eb432a21f0bc4d3d527b2d14f
    /* Creates a small triangle extender for the tooltip */
/*    .d3-tip:after {      
      box-sizing: border-box;
      display: inline;
      font-size: 8px;
      width: 100%;
      line-height: 1.5;
      color: rgba(0, 0, 0, 0.6);
      position: absolute;
      pointer-events: none;
      
    }
  */  
    /* Northward tooltips */
    .d3-tip.n:after {
      content: "\25BC";
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
      text-align: center;
    }

    /* Eastward tooltips */
    .d3-tip.e:after {
      content: "\25C0";
      margin: -4px 0 0 0;
      top: 50%;
      left: -8px;
    }

    /* Southward tooltips */
    .d3-tip.s:after {
      content: "\25B2";
      margin: 0 0 1px 0;
      top: -8px;
      left: 0;
      text-align: center;
    }

    /* Westward tooltips */
    .d3-tip.w:after {
      content: "\25B6";
      margin: -4px 0 0 -1px;
      top: 50%;
      left: 100%;
    }

    .hidden{ 
        display: none; 
    }
</style>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.6/css/bootstrap.min.css">
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.4.min.js"></script>
<script src="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.6/bootstrap.min.js"></script>
<script src="d3-tip.js"></script>
</head>

<div class="container" style="width:1470px">

<div align="center">
  <h1 title="Gentrification">San Francisco Gentrification: Property Trends of 2011-2017</h1>
</div>
<div class="panel panel-default" id="description_container" style="border:1px solid #cecece;" >

        Rising property prices are pushing out people from their homes. Gentrification, the process of renovating and improving a residential district typically old and poorer areas in response to the influx of more affluent residents, has been rapidly accelerating in urban neighborhoods, specifically in the San Francisco area in California. While gentrification improves the quality of life of these neighborhoods, it also adjusts pricing for both renting and owning homes, greatly affecting the affordability. We will explore the evidence of gentrification from 2011 to 2017, in relation to the average income, home sizes (number of rooms), rent, rent to price ratio, etc.
        <br/><br/>
        Assumptions: We have previously determined affordability to be the percentage of income that mortability requires. 
        <br/><br/>
        Analysis: Taking a look at four different years of statistics, 2011, 2013, 2015, and 2017, it is clear for both owning and renting property, that prices have increased drastically. 

</div>

    <div class="panel panel-default" id="options_container" style="width:400px; float:right; height:200px">
        <div id="own_or_rent">
            <label>I am looking to:</label>
            <label class="radio-inline"><input type="radio" name="ownrentradio" id="own_rent_1" value="1">Own Property
            </label>
            <label class="radio-inline"><input type="radio" name="ownrentradio" id="own_rent_2" value="2">Rent Property
            </label>
        </div>
        <br/>
        <div class="hidden" id="ownership_dropdown" style="">

            <label>Ownership Options:</label>
            <select class="dropdown" name="ownership_options" id="ownership_options" style="width:200px"> 
                <option value="%">---------</option>
                <option value="1">Median Listing Price</option>
                <option value="2">Mortgage</option>
                <option value="3">Affordability</option>        
            </select>
        </div>
        <br/>
        <div class="hidden" id="own_radio">
            <label>Ownership Rooms:</label>
            <br/>
            <label class="radio-inline"><input type="radio" name="ownoptradio" id="own_1" value="1">1 Bedroom
            </label>
            <label class="radio-inline"><input type="radio" name="ownoptradio" id="own_2" value="2">2 Bedroom
            </label>
            <label class="radio-inline"><input type="radio" name="ownoptradio" id="own_3" value="3">3 Bedroom
            </label>
        </div>
        <br/>
        <div class="hidden" id="rent_dropdown">
            <label>Rental Options:</label>
            <select class="dropdown" name="rental_options" id="rental_options" style="width:200px"> 
                <option value="%">---------</option>
                <option value="1">Rental Price</option>      
            </select>
        </div>
        <br/>
        <div class="hidden" id="room_radio">
            <label>Rental Options:</label>
            <label class="radio-inline"><input type="radio" name="optradio" id="radio_1" value="1">Multiple Family
            </label>
            <label class="radio-inline"><input type="radio" name="optradio" id="radio_2" value="2">Single Family
            </label>
            <!-- <label class="radio-inline"><input type="radio" name="optradio" id="radio_3" value="3">3 Bedroom
            </label> -->
        </div>
    </div>

<body>
     <div id='vis'></div>
<script>
// Set tooltips
var format = d3.format("");
var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-10, 0])
            .html(function(d) {
              return "<strong>City: </strong><span class='details'>" + d.properties.PO_NAME + "<br></span>" + "<strong>Zip: </strong><span class='details'>" + format(d.properties.ZIP) +"<br></span>"
               +"<strong>" + d.properties.metric +": </strong><span class='details'>" + format(d.properties.val) +"<br></span>"
                +"<strong>Income: </strong><span class='details'>" + format(d.properties.income) +"<br></span>"
                +"<strong>Population: </strong><span class='details'>" + format(d.properties.pop) +"</span>";
            })

var width = 500;
var height = 500;
var color_1 = d3.scaleThreshold()
    //.domain([10000, 20000, 30000, 40000, 50000, 60000, 70000, 80000])
    //.domain([1000, 1500, 2000, 2500, 3000, 3500, 4000, 5000])
    .domain([400000, 500000, 600000, 700000, 800000, 900000, 1000000, 1100000])
    .range(d3.schemeBuPu[9])

var x_1 = d3.scaleSqrt()
    .domain([400000, 1110000])
    .rangeRound([1, 300]);

var color_2 = d3.scaleThreshold()
            .domain([1000, 1500, 2000, 2500, 3000, 3500, 4000, 5000])
            .range(d3.schemeOrRd[9])

var x_2 = d3.scaleSqrt()
    .domain([1000, 5100])
    .rangeRound([1, 300]);
    
    
//var svg = d3.select("body").append("svg")
var topos = ["Bay_Area_new.topojson",
            "NY/NYC.topojson"];
    
var csv_files = [
                "Zip_Zhvi_1bedroom.csv",
                "Zip_Zhvi_2bedroom.csv",
                "Zip_Zhvi_3bedroom.csv",
                "Zip_Zri_MultiFamilyResidenceRental.csv",
                "Zip_Zri_SingleFamilyResidenceRental.csv",
                ];
    
var titles = [
              "Price-1BR",
              "Price-2BR",
              "Price-3BR",
              "Rent Multi Family",
              "Rent-Single Family",
             ];
var legend_titles = [
    "Price in dollars",
    "Price in dollars",
    "Price in dollars",
    "Rent in dollars",
    "Rent in dollars",
    
]

var csv_metric = [
    "Price",
    "Price",
    "Price",
    "Rent",
    "Rent",
];

var colors = [color_1,
              color_1,
              color_1,
              color_2,
              color_2,
              ];
    
var xs = [x_1,
          x_1,
          x_1,
          x_2,
          x_2,
         ];
// All arrays must be same size
if ((csv_files.length != titles.length) ||
    (csv_files.length != colors.length)) {
    throw "Array lengths are not same"
}
var curr_topo_file = 0;
var curr_csv_file = 0;
var num_csv_files = csv_files.length;
console.log("here");
    
function sendArg(arg, callback)
{
    callback(null, arg);
}
function deferDrawMap(topo_index, data_index) {
    console.log("Calling deferDrawMap")
    d3.queue()
    .defer(d3.json, topos[topo_index])
    .defer(d3.csv, csv_files[data_index])
    .defer(d3.csv, "MedianZIP-3-csv.csv")
    .defer(sendArg, topo_index)
    .defer(sendArg, data_index)
    .await(DrawMap)
}
    
deferDrawMap(curr_topo_file, curr_csv_file);
    
//DrawMap(svg); 
function DrawMap(error, bay_area, csv_data, csv_income_pop, topo_index, data_index) {
    if (error) {
        throw error;
    }

    var obj = {};
    for (i = 0; i < 100000; i++) {
        obj[i] = [0, 0, 0, 0];
    }
    
    // Property Data
    csv_data.forEach(function(d) {
        obj[d.RegionName] = [d["2011-11"], d["2013-11"], d["2015-11"], d["2017-11"]];
    });
    
    var income_pop = {};
    for (i = 0; i < 100000; i++) {
        income_pop[i] = [0, 0];
    }
    csv_income_pop.forEach(function(d) {
        income_pop[d.Zip] = [d["Median"], d["Pop"]];                       
    });
    
    //console.log(obj);
    // Projection changes for different cities
    var projection = d3.geoMercator()
    .center([-122.433701, 37.767683])
    .scale(25000)
    .translate([width/2, height/2]);
    var path = d3.geoPath()
      .projection(projection);
    var visualizationWrapper = d3.select('#vis');
    visualizationWrapper.selectAll("div").remove();
    
    for (i = 0; i < obj[0].length; i++)
    {
        var wrapper = visualizationWrapper.append('div')
                        .style("width", width + 'px')
                        .style("height", height + 'px');
        if (i == 0) {
            title1 = titles[data_index];
        } else {
            title1 = "";
        }
        createMap(wrapper, bay_area, obj, income_pop, i, title1, 2011 + i*2);
    }
    
    function showLegend(svg)
    {
        g = svg.append("g")
        .attr("class", "key")
        .attr("transform", "translate(20,450)");

        g.selectAll("rect")
            .data(colors[data_index].range().map(function(d) {
            d = colors[data_index].invertExtent(d);
            if (d[0] == null) d[0] = xs[data_index].domain()[0];
            if (d[1] == null) d[1] = xs[data_index].domain()[1];
            return d;
            }))
            .enter().append("rect")
            .attr("height", 8)
            .attr("x", function(d) { return xs[data_index](d[0]); })
            .attr("width", function(d) { return xs[data_index](d[1]) - xs[data_index](d[0]); })
            .attr("fill", function(d) { return colors[data_index](d[0]); });

                g.append("text")
            .attr("class", "caption")
            .attr("x", xs[data_index].range()[0])
            .attr("y", -6)
            .attr("fill", "#000")
            .attr("text-anchor", "start")
            .attr("font-weight", "bold")
            .text(legend_titles[data_index]);

        var xAxis = d3.axisBottom(xs[data_index])
                    .tickSize(10)
                    .tickValues(colors[data_index].domain());

        g.call(xAxis)
            .select(".domain")
            .remove();
    }
    
    function createMap(wrapper, map, obj, income_pop, key_metric, title1, title2)
    {


        
        var svg = wrapper.append('svg')
                .attr("width", width)
                .attr("height", height);
        svg.call(tip);
        //console.log("Drawing map for " + title2)
        svg.append("g")
        .attr("class", "Zip_areas")
        .selectAll("path")
        .data(topojson.feature(map, map.objects.Zip_areas).features)
        .enter().append("path")
        .attr("fill", function(d) {
            d.properties.val = obj[d.properties.ZIP][key_metric];
            d.properties.metric = csv_metric[data_index];
            d.properties.income = income_pop[d.properties.ZIP][0];
            d.properties.pop = income_pop[d.properties.ZIP][1];
           
            //console.log(d.properties)
            //console.log(obj[d.properties.ZIP]);
            var val = obj[d.properties.ZIP][key_metric];
            if (val == 0) {
                return "lightgrey"
            } else {
                return colors[data_index](val);
            }
        })
        .attr("stroke", "black")
        .attr("stroke-opacity", 1)
        .attr("d", path)
        .on('mouseover', function(d){
           var val = obj[d.properties.ZIP][key_metric];
            d.properties.val = val;
            tip.show(d);
        })
        .on('mouseout', function(d){
            tip.hide(d);
        })
        

        /*Creates the title */
        svg.append("text")
        .attr("x", (50))
        .attr("y", (50))
        .attr("text-anchor", "left")
        .style("font-size", "30px")
        .text(title1); 
        
        svg.append("text")
        .attr("x", (50))
        .attr("y", (100))
        .attr("text-anchor", "left")
        .style("font-size", "30px")
        .text(title2);  

        showLegend(svg);
    }
    
    
    // Code to Redraw maps with new data
    // This can be replaced and call deferDrawMap from Buttons
    curr_csv_file++;
   /* if (curr_csv_file < num_csv_files) {
        setTimeout(function() {
            //console.log("Delay 5000");
            console.log("Draw ", topo_index, curr_csv_file);
            deferDrawMap(0, 4);
        }, 5000);
    }*/
}


$("#own_or_rent").change(function(){
    var own_or_rent = $("input[name='ownrentradio']:checked").val();
    console.log("own_or_rent", own_or_rent);

    if (own_or_rent == 1){
        /* Show Own */
        $('#ownership_dropdown').removeClass('hidden');
        $('#own_radio').removeClass('hidden');

        //clear_rent_options();
        document.getElementById("rent_dropdown").value = 0;
        $("#radio_1").prop("checked", false);
        $("#radio_2").prop("checked", false);
        $('#rent_dropdown').addClass('hidden');
        $('#room_radio').addClass('hidden');

    }
    else if (own_or_rent == 2){
        /* Modify to show 2 bed */
        
        $('#rent_dropdown').removeClass('hidden');
        $('#room_radio').removeClass('hidden');

        //clear_own_options();

        $('#ownership_dropdown').addClass('hidden');
        $('#own_radio').addClass('hidden');
        $("#own_1").prop("checked", false);
        $("#own_2").prop("checked", false);
        $("#own_3").prop("checked", false);
    }

});

$("#ownership_options").change(function(){
    var ownership_option = $( "#ownership_options" ).val();
    console.log("ownership_option", ownership_option);

    if (ownership_option == 1){
        /* Modify to show median listing price */
        deferDrawMap(0, 0);
        /*$("#own_1").prop("checked", true);*/
    }
    else if (ownership_option == 2){
        /* Modify to show mortgage */
    }
    else if (ownership_option == 3){
        /* Modify to show affordability */
    }

});

$("#own_radio").change(function(){
    var own_radio = $("input[name='ownoptradio']:checked").val();
    var ownership_option = $( "#ownership_options" ).val();
    console.log("own_radio", own_radio);

    if (own_radio == 1){
        /* Modify to show 1 bed */
        if (ownership_option == 1)
            deferDrawMap(0, 0);
    }
    else if (own_radio == 2){
        /* Modify to show 2 bed */
        if (ownership_option == 1)
            deferDrawMap(0, 1);
    }
    else if (own_radio == 3){
        /* Modify to show 3 bed */
        if (ownership_option == 1)
            deferDrawMap(0, 2);
    }

});

$("#rental_options").change(function(){
    var rental_option = $( "#rental_options" ).val();
    console.log("rental_option", rental_option);

    if (rental_option == 1){

        /*Autoselect 1 bedroom */
        /*$("#radio_1").prop("checked", true);*/
        deferDrawMap(0, 3);

        /* Modify to show rental price */

    }
});


$("#room_radio").change(function(){
    var room_radio = $("input[name='optradio']:checked").val();
    console.log("room_radio", room_radio);


    if (room_radio == 1){
        deferDrawMap(0, 3);
        /* Modify to show 1 bed */
    }
    else if (room_radio == 2){
        deferDrawMap(0, 4);
        /* Modify to show 2 bed */
    }
/*    else if (room_radio == 3){
    }*/

});



</script> 
</body>
<div class="panel panel-default" id="description_container" style="border:1px solid #cecece;" >
    <div class='row'>
        <div class='col-sm-4'>   
        </div>
    </div>


</div>
<div class="panel panel-default" id="srcs_container" style="border:1px solid #cecece;" >
    <div class='col-sm-4'>
        <div class='row'><label>Files</label></div>
        <div class='row'>Map_2.html</div>
    </div>
    <div class='col-sm-4'>
        <div class='row'><label>Data Sources</label></div>
        <div class='row'><a href="https://www.zillow.com/research/data/">Zillow Research Data</a></div>
        <div class='row'><a href="http://files.zillowstatic.com/research/public/Zip.zip">Zillow Research Data (Property Data by ZIP Code)</a></div>
        <div class='row'><a href="https://earthworks.stanford.edu/catalog/ark28722-s7888q">Bay Area ZIP Code Shapefile</a></div>
        <div class='row'><a href="https://earthworks.stanford.edu/catalog/ark28722-s7888q">Bay Area ZIP Code Shapefile</a></div>
        <div class='row'><a href="https://earthworks.stanford.edu/catalog/sde-columbia-doitt_zip_codes_2009"> New York City Zip Code Shapefile</a></div>
        <div class='row'><a href="https://www.zillow.com/howto/api/neighborhood-boundaries.htm">Neighborhood boundries</a></div>
    </div>
    <div class='row'>
        <div class='col-sm-4'>   
            <label>Visual and Code Sources</label></br>
            <a href="https://github.com/d3/d3/blob/master/API.md">D3 API Reference</a>
            <a hrerf="https://sureshlodha.github.io/CMPS165_Fall2016_FinalProjects/SantaCruzUrbanDisplacement/Urban-Displacement-Santa-Cruz/">Urban Displacement in Santa Cruz County CMPS165 Fall 2016 Project</a>
            <a href="http://frankbowers24.github.io/">Bay Area Stats using D3</a>
            <a href="http://www.urbandisplacement.org/map/sf"> Urban Displacement Project: SF Map</a>
        </div>
    </div>

</div>
<div class="panel panel-default" id="description_container" style="border:1px solid #cecece;" >

Created by Nakul Dhotre (nakul at soe.ucsc.edu) and Catherine Lu (clu47 @ ucsc.edu).
<br/>Designed for CMPS 263 Class Project

</div>
</div>